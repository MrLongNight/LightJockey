# LightJockey Workflow Documentation

This document describes the GitHub Actions workflows that implement the fully autonomous end-to-end development cycle for the LightJockey project.

## Overview

The LightJockey repository uses an automated development cycle that reads tasks from the development plan, creates branches and pull requests, runs CI tests, and automatically merges successful changes back to the main branch. This creates a continuous loop that processes tasks sequentially without manual intervention.

## Workflow Architecture

The automation system consists of four main workflows that work together to implement the autonomous development cycle:

```
┌─────────────────────────────────────────────────────────────┐
│                    AUTOMATION LOOP                          │
└─────────────────────────────────────────────────────────────┘

Push to main
     │
     ▼
┌─────────────────────────────────────────────┐
│  Flow Auto-Task 01: Start Next Task        │
│  (flow-autotask_01-start.yml)              │
│                                             │
│  1. Read LIGHTJOCKEY_Entwicklungsplan.md   │
│  2. Find first uncompleted task (- [ ])    │
│  3. Create feature branch                   │
│  4. Create GitHub issue (autogenerated)     │
│  5. Create draft pull request              │
└─────────────────────────────────────────────┘
     │
     │ PR created
     ▼
┌─────────────────────────────────────────────┐
│  CODE IMPLEMENTATION                        │
│  (AI Coding Assistant / Copilot)           │
│                                             │
│  - Implement task requirements              │
│  - Write unit tests                         │
│  - Push code to feature branch             │
└─────────────────────────────────────────────┘
     │
     │ Code pushed
     ▼
┌─────────────────────────────────────────────┐
│  Flow CI 01: Build & Test                  │
│  (flow-ci_01-build-and-test.yml)          │
│                                             │
│  1. Checkout code                           │
│  2. Restore dependencies                    │
│  3. Build solution                          │
│  4. Run unit tests                          │
│  5. Upload coverage reports                 │
└─────────────────────────────────────────────┘
     │
     │ Tests successful
     ▼
┌─────────────────────────────────────────────┐
│  Flow Auto-Task 02: Test & Merge           │
│  (flow-autotask_02-merge.yml)              │
│                                             │
│  1. Verify PR has autogenerated label       │
│  2. Convert draft PR to ready for review    │
│  3. Add automerge label                     │
│  4. Squash merge to main                    │
└─────────────────────────────────────────────┘
     │
     │ Merge to main
     └──────────┐
                │
                └──> LOOP RESTARTS (back to Flow Auto-Task 01)
```

## Workflow Files

### 1. flow-ci_01-build-and-test.yml

**Name:** "Flow CI 01: Build & Test"

**Purpose:** Continuous Integration workflow that builds the solution and runs all unit tests.

**Triggers:**
- Pull request to `main` or `develop` branches
- Push to `main` or `develop` branches

**Jobs:**
1. **test**: Runs on Windows
   - Checks out the code
   - Sets up .NET 9.0
   - Restores NuGet dependencies
   - Builds the solution in Release configuration
   - Runs xUnit tests with code coverage
   - Uploads coverage reports to Codecov

**Key Features:**
- Uses Windows runner (required for WPF application)
- Collects code coverage with XPlat Code Coverage
- Integrates with Codecov for coverage tracking
- Triggers the auto-merge workflow on success

### 2. flow-autotask_01-start.yml

**Name:** "Flow Auto-Task 01: Start Next Task"

**Purpose:** Initiates the automation loop by identifying the next uncompleted task and creating the necessary GitHub resources.

**Triggers:**
- Push to `main` branch
- Manual workflow dispatch

**Jobs:**
1. **start-next-task**: Runs on Ubuntu
   - Checks if `AUTOMATION_ENABLED` variable is set to `true`
   - Reads `LIGHTJOCKEY_Entwicklungsplan.md`
   - Finds the first line starting with `- [ ]` (uncompleted task)
   - Extracts task number and description
   - Creates a feature branch (e.g., `feature/task-11-autogenerated`)
   - Creates a GitHub issue with label `autogenerated`
   - Creates a draft pull request targeting `main`

**Task Detection Logic:**
- Searches for lines matching pattern: `- [ ]`
- Extracts task number from text (e.g., "Task 11")
- Generates branch name: `feature/task-{number}-autogenerated`
- Stops if no uncompleted tasks are found (cycle complete)

**Abort Conditions:**
- `AUTOMATION_ENABLED` variable is not set to `true`
- No uncompleted tasks found in development plan
- Branch, issue, or PR already exists for the task

### 3. flow-autotask_02-merge.yml

**Name:** "Flow Auto-Task 02: Test & Merge"

**Purpose:** Automatically merges pull requests after successful CI tests.

**Triggers:**
- Completion of "Flow CI 01: Build & Test" workflow
- Only on successful completion (`conclusion == 'success'`)

**Jobs:**
1. **auto-merge**: Runs on Ubuntu
   - Checks if `AUTOMATION_ENABLED` variable is set to `true`
   - Verifies the workflow run was for a pull request
   - Finds the associated PR
   - Verifies PR has `autogenerated` label
   - Converts draft PR to ready for review (if draft)
   - Adds `automerge` label
   - Performs squash merge to `main` branch

**Merge Method:**
- Uses **squash merge** to keep history clean
- Combines all commits from the feature branch into one
- Automatically closes associated issue

**Error Handling:**
- Comments on PR if merge fails
- Provides error details and suggestions
- Does not fail silently

### 4. flow-release_01-msi.yml

**Name:** "Flow Release 01: Create MSI Installer"

**Purpose:** Creates MSI installer packages for Windows distribution.

**Triggers:**
- Manual workflow dispatch (with optional version input)
- Push to version tags (e.g., `v1.0.0`)

**Jobs:**
1. **release**: Runs on Windows
   - Builds the solution in Release configuration
   - Runs tests to verify quality
   - Publishes the application
   - Installs WiX Toolset v4
   - Generates MSI installer package
   - Uploads MSI as artifact
   - Creates GitHub release (on tag push)

**Key Features:**
- Automatic version detection from git tags
- Self-contained MSI with all dependencies
- 90-day artifact retention
- Automatic release creation for tagged versions

## Global Control: AUTOMATION_ENABLED

The entire automation cycle is controlled by a repository variable:

**Variable Name:** `AUTOMATION_ENABLED`

**Values:**
- `true`: Automation is active, workflows will execute
- `false` or not set: Automation is disabled, workflows exit early

**Setting the Variable:**
1. Go to repository Settings
2. Navigate to Secrets and variables → Actions → Variables
3. Create or update `AUTOMATION_ENABLED`
4. Set value to `true` to enable automation

This acts as a global "emergency stop" that can immediately halt all automated task processing without modifying workflow files.

## Error Handling

### Test Failures

If the CI workflow fails (build errors, test failures):
1. Auto-merge workflow is **not triggered**
2. Loop is **paused** for that task
3. Developer must fix the issue in the feature branch
4. New push restarts CI tests
5. On success, auto-merge resumes

### Merge Conflicts

If auto-merge encounters conflicts:
1. Workflow adds a comment to the PR with error details
2. PR remains open for manual resolution
3. Loop is **paused** until resolved
4. After manual merge, push to `main` restarts the loop

### Missing Tasks

If no uncompleted tasks are found:
1. Flow Auto-Task 01 logs completion message
2. Workflow exits gracefully
3. No new branches/PRs are created
4. Loop naturally terminates

## Development Plan Format

The automation expects the development plan (`LIGHTJOCKEY_Entwicklungsplan.md`) to follow this format:

**Task Definitions:**
```markdown
Task 11 — Additional Light Effects

PR-Designation: Task11_AdditionalEffects
Description: New effects (Rainbow, Strobe, Smooth Fade)
...
```

**Master Checklist Table:**
```markdown
4. Master Checkliste (Execution Checklist)

Task	PR-Bezeichnung	Umsetzung abgeschlossen	Doku-Link	QA-Check (manuell)

11	Task11_AdditionalEffects	⬜	[link]	⬜
12	Task12_EffectParameterAdjustment	✅	[docs/tasks/Task12_EffectParameterAdjustment.md](docs/tasks/Task12_EffectParameterAdjustment.md)	✅
```

**Task Detection Logic:**
1. The workflow parses the "Master Checkliste" table to identify completed tasks (marked with ✅)
2. It finds all task definitions in the document (lines starting with `Task N —`)
3. It identifies the first task number that appears in the document but is NOT marked as completed in the checklist
4. Task numbers must be sequential integers (0, 1, 2, etc.)

**Completion Status:**
- Uncompleted: Checkbox in checklist shows `⬜`
- Completed: Checkbox in checklist shows `✅`

## File Structure

```
.github/
└── workflows/
    ├── flow-ci_01-build-and-test.yml      # CI: Build and test
    ├── flow-autotask_01-start.yml         # Automation: Start task
    ├── flow-autotask_02-merge.yml         # Automation: Auto-merge
    ├── flow-release_01-msi.yml            # Release: MSI packaging
    └── build.yml                           # Legacy build workflow
```

## Usage Examples

### Starting the Automation

1. Ensure `AUTOMATION_ENABLED` is set to `true`
2. Push any commit to `main` branch:
   ```bash
   git push origin main
   ```
3. Workflow automatically starts, finds next task, creates PR

### Manual Trigger

You can manually trigger task creation:
1. Go to Actions tab in GitHub
2. Select "Flow Auto-Task 01: Start Next Task"
3. Click "Run workflow"
4. Select branch (usually `main`)
5. Click "Run workflow" button

### Stopping Automation

To halt the automation loop:
1. Set `AUTOMATION_ENABLED` variable to `false`
2. Current running workflows will complete
3. No new tasks will be started
4. Existing PRs remain open for manual handling

### Monitoring Progress

Track automation progress:
1. **Actions Tab**: View workflow runs and status
2. **Issues**: Check for `autogenerated` label
3. **Pull Requests**: Check for `automerge` label
4. **Development Plan**: Check for completed tasks (✅)

## Best Practices

1. **Keep AUTOMATION_ENABLED disabled during initial setup**
   - Test workflows manually first
   - Verify each component works correctly
   - Enable only when confident

2. **Monitor the first few cycles closely**
   - Check task detection is correct
   - Verify PRs are created properly
   - Ensure merges complete successfully

3. **Review code before enabling automation**
   - AI-generated code should be reviewed
   - Critical tasks may need manual oversight
   - Use automation for well-defined tasks

4. **Maintain clean development plan**
   - Use consistent task numbering
   - Mark completed tasks clearly
   - Keep task descriptions concise

5. **Set up branch protection rules**
   - Require status checks to pass
   - Prevent force pushes
   - Consider requiring reviews for sensitive tasks

## Troubleshooting

### Workflow Not Starting

**Problem:** Flow Auto-Task 01 doesn't start after push to main

**Solutions:**
- Check `AUTOMATION_ENABLED` is set to `true`
- Verify workflow file syntax is valid
- Check GitHub Actions is enabled for repository
- Review workflow run logs for errors

### Task Not Found

**Problem:** Workflow reports "No uncompleted tasks found"

**Solutions:**
- Check development plan has tasks with `- [ ]` format
- Verify file name is exactly `LIGHTJOCKEY_Entwicklungsplan.md`
- Ensure task lines start with `- [ ]` (dash-space-bracket-space-bracket)

### Auto-Merge Fails

**Problem:** PR not merged automatically after tests pass

**Solutions:**
- Verify PR has `autogenerated` label
- Check CI workflow completed successfully
- Review workflow_run trigger permissions
- Check for merge conflicts
- Verify branch protection rules allow auto-merge

### Branch Already Exists

**Problem:** Workflow skips task creation (branch exists)

**Solutions:**
- Check if PR for that branch is still open
- If PR was manually closed, delete the branch
- If task was abandoned, mark it completed in plan

## Security Considerations

1. **Limited Permissions**: Workflows use minimal required permissions
2. **Label Verification**: Auto-merge only processes PRs with `autogenerated` label
3. **Success Validation**: Merge only occurs after successful test runs
4. **Audit Trail**: All actions logged in workflow runs
5. **Manual Override**: `AUTOMATION_ENABLED` allows immediate shutdown

## Future Enhancements

Potential improvements to the automation system:

1. **Task Validation**: Pre-validate task requirements before PR creation
2. **Parallel Processing**: Handle multiple tasks simultaneously
3. **Smart Scheduling**: Priority-based task selection
4. **Progress Notifications**: Slack/Discord integration for updates
5. **Rollback Capability**: Automatic revert on production issues
6. **Code Review Integration**: AI code review before merge
7. **Dependency Detection**: Identify and handle task dependencies

## Contributing

When modifying the automation workflows:

1. Test changes in a fork first
2. Use workflow_dispatch triggers for testing
3. Verify all four workflows work together
4. Update this documentation
5. Add comments explaining complex logic

## Support

For issues with the automation workflows:

1. Check workflow run logs in Actions tab
2. Review this documentation
3. Check GitHub Actions documentation
4. Open an issue with `workflow` label
5. Include workflow run ID and error messages

---

**Document Version:** 1.0  
**Last Updated:** 2025-11-12  
**Maintained By:** LightJockey Development Team
