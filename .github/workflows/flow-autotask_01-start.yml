name: "Flow Auto-Task 01: Start Next Task"

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  start-next-task:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
      - name: Check if automation is enabled
        id: check_enabled
        run: |
          # Check if AUTOMATION_ENABLED variable exists and is set to true
          if [ "${{ vars.AUTOMATION_ENABLED }}" != "true" ]; then
            echo "Automation is disabled. Set AUTOMATION_ENABLED repository variable to 'true' to enable."
            echo "enabled=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "enabled=true" >> $GITHUB_OUTPUT
      
      - name: Checkout repository
        if: steps.check_enabled.outputs.enabled == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Find next uncompleted task
        if: steps.check_enabled.outputs.enabled == 'true'
        id: find_task
        run: |
          # Read the development plan and find the first uncompleted task
          PLAN_FILE="LIGHTJOCKEY_Entwicklungsplan.md"
          
          # Find tasks that are NOT marked as completed (ABGESCHLOSSEN)
          # We look for "Task X —" headers that don't have "ABGESCHLOSSEN" in the following 5 lines
          TASK_NUM=""
          TASK_TITLE=""
          
          # Parse the file and find uncompleted tasks
          while IFS= read -r line; do
            # Check if this is a task header (e.g., "Task 11 — Additional Light Effects")
            if echo "$line" | grep -qE '^Task [0-9]+ —'; then
              # Extract task number
              CURRENT_TASK=$(echo "$line" | grep -oP 'Task \K[0-9]+')
              CURRENT_TITLE=$(echo "$line" | sed 's/^Task [0-9]* — //')
              
              # Read next few lines to check if completed
              IS_COMPLETED=false
              for i in {1..5}; do
                read -r next_line || break
                if echo "$next_line" | grep -q "ABGESCHLOSSEN\|✅ COMPLETED"; then
                  IS_COMPLETED=true
                  break
                fi
                # If we hit another task header, stop checking
                if echo "$next_line" | grep -qE '^Task [0-9]+ —'; then
                  # Put the line back (we'll process it in next iteration)
                  break
                fi
              done
              
              # If not completed, this is our task
              if [ "$IS_COMPLETED" = false ] && [ -z "$TASK_NUM" ]; then
                TASK_NUM="$CURRENT_TASK"
                TASK_TITLE="$CURRENT_TITLE"
                break
              fi
            fi
          done < "$PLAN_FILE"
          
          if [ -z "$TASK_NUM" ]; then
            echo "No uncompleted tasks found. Automation cycle complete!"
            echo "has_task=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "has_task=true" >> $GITHUB_OUTPUT
          
          echo "Found uncompleted task: Task $TASK_NUM — $TASK_TITLE"
          
          # Create branch name
          BRANCH_NAME="feature/task-${TASK_NUM}-autogenerated"
          
          # Clean task text for title (limit to 80 chars)
          TASK_TITLE_SHORT=$(echo "$TASK_TITLE" | cut -c1-80)
          
          echo "task_num=$TASK_NUM" >> $GITHUB_OUTPUT
          echo "task_title=$TASK_TITLE_SHORT" >> $GITHUB_OUTPUT
          echo "task_text=$TASK_TITLE" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
      
      - name: Create feature branch
        if: steps.check_enabled.outputs.enabled == 'true' && steps.find_task.outputs.has_task == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          BRANCH_NAME="${{ steps.find_task.outputs.branch_name }}"
          
          # Check if branch already exists
          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "Branch $BRANCH_NAME already exists. Skipping task creation."
            exit 0
          fi
          
          # Create and push new branch
          git checkout -b "$BRANCH_NAME"
          git push origin "$BRANCH_NAME"
      
      - name: Create GitHub Issue
        if: steps.check_enabled.outputs.enabled == 'true' && steps.find_task.outputs.has_task == 'true'
        id: create_issue
        uses: actions/github-script@v7
        with:
          script: |
            const taskTitle = `${{ steps.find_task.outputs.task_title }}`;
            const taskText = `${{ steps.find_task.outputs.task_text }}`;
            const taskNum = `${{ steps.find_task.outputs.task_num }}`;
            
            // Check if issue already exists
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'autogenerated'
            });
            
            const issueExists = existingIssues.data.some(issue => 
              issue.title.includes(taskTitle)
            );
            
            if (issueExists) {
              console.log('Issue already exists for this task');
              return;
            }
            
            // Create new issue
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: taskTitle,
              body: `## Auto-generated Task\n\n${taskText}\n\n---\n\n**Source:** LIGHTJOCKEY_Entwicklungsplan.md\n**Task Number:** ${taskNum}\n**Branch:** \`${{ steps.find_task.outputs.branch_name }}\`\n\nThis issue was automatically created by the automation workflow.`,
              labels: ['autogenerated']
            });
            
            console.log(`Created issue #${issue.data.number}`);
            return issue.data.number;
      
      - name: Create Draft Pull Request
        if: steps.check_enabled.outputs.enabled == 'true' && steps.find_task.outputs.has_task == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const taskTitle = `${{ steps.find_task.outputs.task_title }}`;
            const taskNum = `${{ steps.find_task.outputs.task_num }}`;
            const branchName = `${{ steps.find_task.outputs.branch_name }}`;
            const issueNumber = `${{ steps.create_issue.outputs.result }}`;
            
            // Check if PR already exists
            const existingPRs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${branchName}`
            });
            
            if (existingPRs.data.length > 0) {
              console.log('PR already exists for this branch');
              return;
            }
            
            // Create draft PR
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Task ${taskNum}: ${taskTitle}`,
              head: branchName,
              base: 'main',
              body: `## Auto-generated Pull Request\n\n${taskTitle}\n\n---\n\nCloses #${issueNumber}\n\nThis PR was automatically created by the automation workflow.\n\n**Next Steps:**\n1. AI coding assistant will implement the required changes\n2. CI will build and test automatically\n3. On success, PR will be auto-merged`,
              draft: true
            });
            
            console.log(`Created draft PR #${pr.data.number}`);
