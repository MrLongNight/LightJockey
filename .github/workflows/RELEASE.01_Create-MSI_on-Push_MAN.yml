name: "RELEASE.01_Create-MSI_on-Push_MAN.yml"

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: false
        default: '1.0.0'

env:
  DOTNET_VERSION: '9.0.x'
  PROJECT_PATH: 'src/LightJockey/LightJockey.csproj'
  SOLUTION_PATH: 'LightJockey.sln'
  BUILD_CONFIGURATION: 'Release'
  PUBLISH_DIR: 'publish'
  ARTIFACT_NAME: 'LightJockey-MSI'

jobs:
  release:
    name: Build and Package MSI (Pre-Release)
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.nuget/packages
        key: nuget-packages-${{ runner.os }}-${{ hashFiles('**/*.sln', '**/*.csproj') }}
        restore-keys: |
          nuget-packages-${{ runner.os }}-

    - name: Get version
      id: get_version
      shell: pwsh
      run: |
        $version = "${{ github.event.inputs.version }}"
        if ([string]::IsNullOrEmpty($version)) {
          $version = "1.0.0"
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Version: $version"

    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_PATH }}

    - name: Build solution
      run: dotnet build ${{ env.SOLUTION_PATH }} --no-restore --configuration ${{ env.BUILD_CONFIGURATION }}

    - name: Run tests
      run: dotnet test ${{ env.SOLUTION_PATH }} --no-build --configuration ${{ env.BUILD_CONFIGURATION }} --verbosity normal

    - name: Publish application
      run: |
        dotnet publish ${{ env.PROJECT_PATH }} `
          --configuration ${{ env.BUILD_CONFIGURATION }} `
          --runtime win-x64 `
          --self-contained false `
          --output ${{ env.PUBLISH_DIR }}

    - name: Install WiX Toolset
      run: |
        dotnet tool install --global wix
        wix --version

    - name: Build MSI with WiX
      shell: pwsh
      run: |
        # Install WiX extension
        wix extension add WixToolset.Util.wixext
        
        $version = "${{ steps.get_version.outputs.VERSION }}"
        
        # Get all files to include
        $files = Get-ChildItem -Path "${{ env.PUBLISH_DIR }}" -Recurse -File
        
        $componentRefs = ""
        $components = ""
        $fileId = 1
        
        foreach ($file in $files) {
          $relativePath = $file.FullName.Replace("$PWD\${{ env.PUBLISH_DIR }}\", "")
          $componentId = "Comp$fileId"
          
          $components += @"
              <Component Id="$componentId" Guid="*">
                <File Id="File$fileId" Source="${{ env.PUBLISH_DIR }}\$relativePath" KeyPath="yes" />
              </Component>
        "@
          $componentRefs += "      <ComponentRef Id=`"$componentId`" />`n"
          $fileId++
        }
        
        $wxsContent = @"
        <?xml version="1.0" encoding="UTF-8"?>
        <Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
          <Package Name="LightJockey" 
                   Version="$version" 
                   Manufacturer="LightJockey" 
                   UpgradeCode="A1B2C3D4-E5F6-4A5B-8C9D-0E1F2A3B4C5D"
                   Language="1033">
            
            <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
            
            <MediaTemplate EmbedCab="yes" />

            <StandardDirectory Id="ProgramFiles64Folder">
              <Directory Id="INSTALLFOLDER" Name="LightJockey">
                $components
              </Directory>
            </StandardDirectory>

            <Feature Id="ProductFeature" Title="LightJockey" Level="1">
        $componentRefs
            </Feature>
          </Package>
        </Wix>
        "@
        
        New-Item -ItemType Directory -Force -Path "installer"
        $wxsContent | Out-File -FilePath "installer\LightJockey.wxs" -Encoding UTF8
        
        # Build the MSI
        wix build -arch x64 -o "LightJockey-v$version.msi" "installer\LightJockey.wxs"

    - name: Upload MSI artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.ARTIFACT_NAME }}
        path: '*.msi'
        retention-days: 90

    - name: Create Pre-Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.get_version.outputs.VERSION }}-pre
        name: Pre-Release v${{ steps.get_version.outputs.VERSION }}
        files: '*.msi'
        draft: false
        prerelease: true
        body: |
          ## Pre-Release Build
          
          This is a pre-release version created manually for testing purposes.
          
          **Version:** ${{ steps.get_version.outputs.VERSION }}
          **Build Date:** ${{ github.event.repository.updated_at }}
          
          ### Installation
          Download the MSI installer and run it on Windows.
          
          ### Note
          This is a pre-release build and may contain bugs or unstable features.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
