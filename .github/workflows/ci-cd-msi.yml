name: CI/CD - Build, Test & MSI Package

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '9.0.x'
  PROJECT_PATH: 'src/LightJockey/LightJockey.csproj'
  SOLUTION_PATH: 'LightJockey.sln'
  BUILD_CONFIGURATION: 'Release'
  PUBLISH_DIR: 'publish'
  ARTIFACT_NAME: 'LightJockey-MSI'

jobs:
  build:
    name: Build
    runs-on: windows-latest
    permissions:
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_PATH }}

    - name: Build solution
      run: dotnet build ${{ env.SOLUTION_PATH }} --no-restore --configuration ${{ env.BUILD_CONFIGURATION }}

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-output
        path: |
          src/LightJockey/bin/${{ env.BUILD_CONFIGURATION }}/
          tests/LightJockey.Tests/bin/${{ env.BUILD_CONFIGURATION }}/
        retention-days: 1

  test:
    name: Test
    runs-on: windows-latest
    needs: build
    permissions:
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_PATH }}

    - name: Run tests
      run: dotnet test ${{ env.SOLUTION_PATH }} --configuration ${{ env.BUILD_CONFIGURATION }} --verbosity normal --collect:"XPlat Code Coverage" --logger "trx;LogFileName=test-results.trx"

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: '**/TestResults/**'
        retention-days: 7

    - name: Upload coverage reports
      uses: codecov/codecov-action@v4
      if: success()
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: '**/coverage.cobertura.xml'
        fail_ci_if_error: false

  package-msi:
    name: Package MSI
    runs-on: windows-latest
    needs: test
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Get version from git tag
      id: get_version
      shell: pwsh
      run: |
        $version = "1.0.0"
        $tag = git describe --tags --abbrev=0 2>$null
        if ($tag -match '^v?(\d+\.\d+\.\d+)') {
          $version = $matches[1]
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Version: $version"

    - name: Restore dependencies
      run: dotnet restore ${{ env.PROJECT_PATH }}

    - name: Publish application
      run: |
        dotnet publish ${{ env.PROJECT_PATH }} `
          --configuration ${{ env.BUILD_CONFIGURATION }} `
          --runtime win-x64 `
          --self-contained false `
          --output ${{ env.PUBLISH_DIR }} `
          -p:PublishSingleFile=false `
          -p:PublishReadyToRun=false

    - name: Install WiX Toolset
      run: |
        dotnet tool install --global wix
        wix --version

    - name: Create WiX source file
      shell: pwsh
      run: |
        $version = "${{ steps.get_version.outputs.VERSION }}"
        $wxsContent = @"
        <?xml version="1.0" encoding="UTF-8"?>
        <Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
          <Package Name="LightJockey" 
                   Version="$version" 
                   Manufacturer="LightJockey" 
                   UpgradeCode="12345678-1234-1234-1234-123456789012"
                   Language="1033"
                   Codepage="1252">
            
            <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
            
            <Media Id="1" Cabinet="LightJockey.cab" EmbedCab="yes" />

            <StandardDirectory Id="ProgramFiles64Folder">
              <Directory Id="INSTALLFOLDER" Name="LightJockey">
                <Component>
                  <File Source="${{ env.PUBLISH_DIR }}\LightJockey.exe" />
                  <File Source="${{ env.PUBLISH_DIR }}\LightJockey.dll" />
                  <File Source="${{ env.PUBLISH_DIR }}\LightJockey.runtimeconfig.json" />
                  <File Source="${{ env.PUBLISH_DIR }}\LightJockey.deps.json" />
                </Component>
                <Component>
                  <File Source="${{ env.PUBLISH_DIR }}\*.dll" />
                </Component>
              </Directory>
            </StandardDirectory>

            <Feature Id="ProductFeature" Title="LightJockey" Level="1">
              <ComponentGroupRef Id="ProductComponents" />
            </Feature>
          </Package>

          <Fragment>
            <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER" />
          </Fragment>
        </Wix>
        "@
        
        New-Item -ItemType Directory -Force -Path "installer"
        $wxsContent | Out-File -FilePath "installer\LightJockey.wxs" -Encoding UTF8

    - name: Build MSI with WiX (heat and light)
      shell: pwsh
      run: |
        # Generate file list using heat
        wix extension add WixToolset.Util.wixext
        
        # Create a simplified WiX file that works with WiX v4
        $version = "${{ steps.get_version.outputs.VERSION }}"
        $guid = [guid]::NewGuid().ToString().ToUpper()
        
        # Get all files to include
        $files = Get-ChildItem -Path "${{ env.PUBLISH_DIR }}" -Recurse -File
        
        $componentRefs = ""
        $components = ""
        $fileId = 1
        
        foreach ($file in $files) {
          $relativePath = $file.FullName.Replace("$PWD\${{ env.PUBLISH_DIR }}\", "")
          $componentId = "Comp$fileId"
          $fileGuid = [guid]::NewGuid().ToString().ToUpper()
          
          $components += @"
              <Component Id="$componentId" Guid="$fileGuid">
                <File Id="File$fileId" Source="${{ env.PUBLISH_DIR }}\$relativePath" KeyPath="yes" />
              </Component>
        "@
          $componentRefs += "      <ComponentRef Id=`"$componentId`" />`n"
          $fileId++
        }
        
        $wxsContent = @"
        <?xml version="1.0" encoding="UTF-8"?>
        <Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
          <Package Name="LightJockey" 
                   Version="$version" 
                   Manufacturer="LightJockey" 
                   UpgradeCode="A1B2C3D4-E5F6-4A5B-8C9D-0E1F2A3B4C5D"
                   Language="1033">
            
            <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
            
            <MediaTemplate EmbedCab="yes" />

            <StandardDirectory Id="ProgramFiles64Folder">
              <Directory Id="INSTALLFOLDER" Name="LightJockey">
                $components
              </Directory>
            </StandardDirectory>

            <Feature Id="ProductFeature" Title="LightJockey" Level="1">
        $componentRefs
            </Feature>
          </Package>
        </Wix>
        "@
        
        $wxsContent | Out-File -FilePath "installer\LightJockey.wxs" -Encoding UTF8
        
        # Build the MSI
        wix build -arch x64 -o "LightJockey-v$version.msi" "installer\LightJockey.wxs"

    - name: Upload MSI artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.ARTIFACT_NAME }}
        path: '*.msi'
        retention-days: 90

    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: '*.msi'
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build, test, package-msi]
    if: always()
    permissions:
      contents: read

    steps:
    - name: Generate Summary
      run: |
        echo "## CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Test | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Package MSI | ${{ needs.package-msi.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- Build output" >> $GITHUB_STEP_SUMMARY
        echo "- Test results" >> $GITHUB_STEP_SUMMARY
        echo "- MSI installer package" >> $GITHUB_STEP_SUMMARY
