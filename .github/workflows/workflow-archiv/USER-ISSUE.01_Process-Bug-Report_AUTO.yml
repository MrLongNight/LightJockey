name: "USER-ISSUE.01_Process-Bug-Report_AUTO.yml"

# This workflow automatically processes bug reports submitted by users
# Bug reports are fully automated and immediately submitted to Jules

on:
  issues:
    types: [opened, labeled]

jobs:
  process-bug-report:
    runs-on: ubuntu-latest
    # Only run for issues with the 'jules-auto-process' label (bug reports)
    if: contains(github.event.issue.labels.*.name, 'jules-auto-process')
    permissions:
      issues: write
      contents: write
      pull-requests: write
    
    steps:
      - name: Check if Jules automation is enabled
        id: check_enabled
        run: |
          if [ "${{ vars.JULES_AUTOMATION_ENABLED }}" != "true" ]; then
            echo "Jules automation is disabled. Set JULES_AUTOMATION_ENABLED repository variable to 'true' to enable."
            echo "enabled=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "enabled=true" >> $GITHUB_OUTPUT
      
      - name: Validate Jules API key
        if: steps.check_enabled.outputs.enabled == 'true'
        run: |
          if [ -z "${{ secrets.JulesAPIKey }}" ]; then
            echo "Error: JulesAPIKey secret is not set."
            exit 1
          fi
      
      - name: Add processing comment
        if: steps.check_enabled.outputs.enabled == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.issue.number;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `## ðŸ¤– Automatische Verarbeitung gestartet
              
              Vielen Dank fÃ¼r deinen Bug Report! Dieser wird jetzt automatisch von Jules AI Agent bearbeitet.
              
              ### Was passiert als nÃ¤chstes:
              
              1. âœ… Jules analysiert den Bug
              2. âœ… Eine LÃ¶sung wird entwickelt
              3. âœ… Ein Pull Request wird automatisch erstellt
              4. âœ… Unit-Tests werden ausgefÃ¼hrt
              5. âœ… Code wird automatisch gemergt, wenn Tests erfolgreich sind
              
              ### Du wirst benachrichtigt wenn:
              - âš ï¸ Die Unit-Tests fehlschlagen und manuelle PrÃ¼fung erforderlich ist
              - âœ… Der Bug erfolgreich behoben wurde
              
              **Status:** â³ Warte auf Jules Session-Erstellung...`
            });
      
      - name: Checkout repository
        if: steps.check_enabled.outputs.enabled == 'true'
        uses: actions/checkout@v4
      
      - name: Get Jules source
        if: steps.check_enabled.outputs.enabled == 'true'
        id: get_source
        run: |
          RESPONSE=$(curl -s 'https://jules.googleapis.com/v1alpha/sources' \
            -H "X-Goog-Api-Key: ${{ secrets.JulesAPIKey }}")
          
          SOURCE_NAME=$(echo "$RESPONSE" | jq -r ".sources[] | select(.githubRepo.owner==\"${{ github.repository_owner }}\" and .githubRepo.repo==\"${{ github.event.repository.name }}\") | .name")
          
          if [ -z "$SOURCE_NAME" ] || [ "$SOURCE_NAME" = "null" ]; then
            echo "Error: Repository not found in Jules sources."
            exit 1
          fi
          
          echo "source_name=$SOURCE_NAME" >> $GITHUB_OUTPUT
      
      - name: Create Jules session for bug fix
        if: steps.check_enabled.outputs.enabled == 'true'
        id: create_session
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const issueNumber = issue.number;
            const issueTitle = issue.title;
            const issueBody = issue.body || '';
            const sourceName = '${{ steps.get_source.outputs.source_name }}';
            
            // Create prompt for Jules
            const prompt = `Fix Bug Report from User - Issue #${issueNumber}: ${issueTitle}

            ${issueBody}

            Please analyze this bug report and implement a fix following these guidelines:
            - Use the MVVM pattern (Models, ViewModels, Views, Services)
            - Implement dependency injection for all services
            - Add comprehensive unit tests with xUnit and Moq to verify the fix
            - Follow C# and WPF best practices
            - Add XML documentation for any modified public members
            - Ensure code coverage is above 80%
            - Update relevant documentation if needed

            The fix should address the root cause and prevent similar issues in the future.`;
            
            // Create session via Jules API
            const response = await fetch('https://jules.googleapis.com/v1alpha/sessions', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-Goog-Api-Key': '${{ secrets.JulesAPIKey }}'
              },
              body: JSON.stringify({
                prompt: prompt,
                sourceContext: {
                  source: sourceName,
                  githubRepoContext: {
                    startingBranch: 'main'
                  }
                },
                automationMode: 'AUTO_CREATE_PR',
                title: `Fix: ${issueTitle}`
              })
            });
            
            const sessionData = await response.json();
            const sessionId = sessionData.id;
            
            if (!sessionId) {
              throw new Error('Failed to create Jules session');
            }
            
            console.log(`Created Jules session: ${sessionId}`);
            return sessionId;
      
      - name: Update issue with session info
        if: steps.check_enabled.outputs.enabled == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.issue.number;
            const sessionId = ${{ steps.create_session.outputs.result }};
            
            // Add label to track Jules processing
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['jules-processing']
            });
            
            // Add comment with session info
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `## âœ… Jules Session erstellt
              
              **Jules Session ID:** \`${sessionId}\`
              **Session URL:** https://jules.google.com/sessions/${sessionId}
              
              Jules arbeitet jetzt an der Behebung des Bugs. Du kannst den Fortschritt unter dem obigen Link verfolgen.
              
              **NÃ¤chste Schritte:**
              1. Jules analysiert den Bug
              2. Jules erstellt eine LÃ¶sung und einen Pull Request
              3. Automatische Tests werden ausgefÃ¼hrt
              4. Du wirst Ã¼ber den Fortschritt informiert`
            });
