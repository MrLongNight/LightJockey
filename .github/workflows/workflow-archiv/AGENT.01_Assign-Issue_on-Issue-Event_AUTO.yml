name: "AGENT.01_Assign-Issue_on-Issue-Event_AUTO.yml"

# This workflow automatically assigns GitHub Copilot Coding Agent to auto-generated issues
# Based on GitHub Copilot's agentic workflows: https://github.blog/ai-and-ml/github-copilot/from-idea-to-pr-a-guide-to-github-copilots-agentic-workflows/

on:
  issues:
    types: [opened, labeled]

jobs:
  assign-copilot-agent:
    runs-on: ubuntu-latest
    # Only run for issues with both 'autogenerated' and 'copilot-task' labels
    if: contains(github.event.issue.labels.*.name, 'autogenerated') && contains(github.event.issue.labels.*.name, 'copilot-task')
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: Check if automation is enabled
        id: check_enabled
        run: |
          if [ "${{ vars.AUTOMATION_ENABLED }}" != "true" ]; then
            echo "Automation is disabled. Set AUTOMATION_ENABLED repository variable to 'true' to enable."
            echo "enabled=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "enabled=true" >> $GITHUB_OUTPUT
      
      - name: Add copilot agent assignment comment
        if: steps.check_enabled.outputs.enabled == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.issue.number;
            const issueBody = context.payload.issue.body || '';
            
            // Extract task details from issue body
            const taskNumMatch = issueBody.match(/\*\*Task Number:\*\*\s*(\d+)/);
            const taskNum = taskNumMatch ? taskNumMatch[1] : 'N/A';
            
            // Add comment to trigger Copilot Coding Agent
            const comment = `## ü§ñ GitHub Copilot Coding Agent Assignment

This task has been flagged for automated implementation using GitHub Copilot's agentic workflow.

### How to activate the Copilot Agent:

**Option 1: GitHub Web Interface (Recommended)**
1. Look for the Copilot button/icon on this issue page
2. Click it and select **"Assign to Copilot"** or **"Open in Copilot Workspace"**
3. The Copilot Coding Agent will:
   - Analyze the task requirements
   - Create an implementation plan
   - Generate the code changes
   - Commit to the linked PR
   - Run tests and iterate if needed

**Option 2: GitHub CLI**
\`\`\`bash
# Install GitHub CLI extension for Copilot (if not already installed)
gh extension install github/gh-copilot

# Assign this issue to Copilot
gh copilot issue assign ${issueNumber}
\`\`\`

**Option 3: Manual Label-Based Trigger**
- Simply add the label \`copilot:implement\` to this issue
- Copilot will automatically start working on it

### What the Agent Will Do:

‚úÖ Read the task description and development plan  
‚úÖ Analyze existing codebase and architecture  
‚úÖ Generate implementation following MVVM patterns  
‚úÖ Create comprehensive unit tests  
‚úÖ Update documentation  
‚úÖ Commit changes to the feature branch  
‚úÖ Update the linked PR with progress  

### Monitoring Progress:

Check the linked PR for:
- Commits from the Copilot agent
- Implementation logs and explanations
- Test results from CI

### If Copilot Needs Help:

You can interact with the agent by:
- Commenting on the PR with clarifications
- Requesting specific changes
- Providing additional context

---

**Learn More**: [GitHub Copilot Agentic Workflows Guide](https://github.blog/ai-and-ml/github-copilot/from-idea-to-pr-a-guide-to-github-copilots-agentic-workflows/)

**Status**: ‚è≥ Waiting for Copilot agent activation...`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: comment
            });
            
            console.log(`Added Copilot agent instructions to issue #${issueNumber}`);
      
      - name: Add assignment indicator label
        if: steps.check_enabled.outputs.enabled == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.issue.number;
            
            // Add label to indicate Copilot can be assigned
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['ready-for-copilot']
            });
            
            console.log(`Added 'ready-for-copilot' label to issue #${issueNumber}`);
      
      - name: Create notification for repository owner
        if: steps.check_enabled.outputs.enabled == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.issue.number;
            
            // Mention the repository owner so they get a notification
            const notificationComment = `@${{ github.repository_owner }} üëã A new auto-generated task is ready for Copilot Coding Agent.

Please activate the agent using one of the methods described above to begin automated implementation.`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: notificationComment
            });
            
            console.log(`Notified repository owner about issue #${issueNumber}`);
