name: "Jules Monitor and Review (Reusable)"

on:
  workflow_call:
    secrets:
      jules_api_key:
        description: 'Jules API key for authentication'
        required: true
    inputs:
      automation_enabled:
        description: 'Whether Jules automation is enabled'
        required: true
        type: string
      session_id:
        description: 'Jules Session ID to check (optional)'
        required: false
        type: string

jobs:
  monitor-sessions:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
      - name: Check if Jules automation is enabled
        id: check_enabled
        run: |
          if [ "${{ inputs.automation_enabled }}" != "true" ]; then
            echo "Jules automation is disabled."
            echo "enabled=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "enabled=true" >> $GITHUB_OUTPUT
      
      - name: Checkout repository
        if: steps.check_enabled.outputs.enabled == 'true'
        uses: actions/checkout@v4
      
      - name: Find active Jules sessions
        if: steps.check_enabled.outputs.enabled == 'true'
        id: find_sessions
        uses: actions/github-script@v7
        with:
          script: |
            const sessionIdInput = '${{ inputs.session_id }}';
            
            if (sessionIdInput) {
              // Manual trigger with specific session
              return [sessionIdInput];
            }
            
            // Find all open issues with jules-task label
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'jules-task'
            });
            
            // Extract session IDs from issue bodies
            const sessionIds = [];
            for (const issue of issues.data) {
              const match = issue.body.match(/Jules Session ID.*`([^`]+)`/);
              if (match) {
                sessionIds.push(match[1]);
              }
            }
            
            console.log(`Found ${sessionIds.length} active Jules sessions`);
            return sessionIds;
      
      - name: Check Jules sessions
        if: steps.check_enabled.outputs.enabled == 'true'
        id: check_sessions
        run: |
          SESSIONS='${{ steps.find_sessions.outputs.result }}'
          
          if [ "$SESSIONS" = "[]" ] || [ -z "$SESSIONS" ]; then
            echo "No active Jules sessions to monitor."
            echo "has_updates=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Checking Jules sessions..."
          echo "$SESSIONS" | jq -r '.[]' | while read SESSION_ID; do
            echo "Checking session: $SESSION_ID"
            
            # Get session details
            RESPONSE=$(curl -s "https://jules.googleapis.com/v1alpha/sessions/${SESSION_ID}" \
              -H "X-Goog-Api-Key: ${{ secrets.jules_api_key }}")
            
            echo "Session ${SESSION_ID} status:"
            echo "$RESPONSE" | jq '{title, outputs}'
            
            # Check if PR was created
            PR_URL=$(echo "$RESPONSE" | jq -r '.outputs[]?.pullRequest?.url // empty' | head -1)
            
            if [ -n "$PR_URL" ]; then
              echo "PR created: $PR_URL"
              echo "has_updates=true" >> $GITHUB_OUTPUT
              echo "session_id=$SESSION_ID" >> $GITHUB_OUTPUT
              echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
              
              # Extract PR number from URL
              PR_NUMBER=$(echo "$PR_URL" | grep -oP '\d+$')
              echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
              
              break
            fi
          done
      
      - name: Update tracking issue with PR info
        if: steps.check_enabled.outputs.enabled == 'true' && steps.check_sessions.outputs.has_updates == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const sessionId = `${{ steps.check_sessions.outputs.session_id }}`;
            const prUrl = `${{ steps.check_sessions.outputs.pr_url }}`;
            const prNumber = `${{ steps.check_sessions.outputs.pr_number }}`;
            
            // Find the tracking issue for this session
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'jules-task'
            });
            
            const trackingIssue = issues.data.find(issue => 
              issue.body.includes(sessionId)
            );
            
            if (!trackingIssue) {
              console.log('No tracking issue found for session');
              return;
            }
            
            // Update issue with PR information
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: trackingIssue.number,
              body: `## âœ… Jules Created Pull Request

            Jules has completed the implementation and created a pull request!

            **PR:** ${prUrl}

            ### Next Steps
            - â³ Copilot Agent will review the PR
            - â³ CI tests will run automatically
            - â³ PR will be merged if tests pass

            The PR review workflow has been triggered.`
            });
            
            console.log(`Updated issue #${trackingIssue.number} with PR info`);
      
      - name: Trigger Copilot Agent review
        if: steps.check_enabled.outputs.enabled == 'true' && steps.check_sessions.outputs.has_updates == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ steps.check_sessions.outputs.pr_number }}');
            
            // Get the PR
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            // Add labels for Copilot Agent review
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ['jules-pr', 'needs-review', 'copilot-review']
            });
            
            // Comment on PR to request Copilot review
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `## ðŸ¤– Automated Review Request

            This PR was created by Jules AI agent. Requesting automated review.

            @copilot Please review this pull request and check for:
            - Code quality and best practices
            - Test coverage (should be >80%)
            - MVVM pattern compliance
            - Dependency injection usage
            - XML documentation completeness
            - Any potential bugs or issues

            If you find any issues, please suggest fixes or make corrections directly.

            ### Review Checklist
            - [ ] Code follows MVVM pattern
            - [ ] Unit tests are comprehensive
            - [ ] Code coverage >80%
            - [ ] XML documentation present
            - [ ] No obvious bugs
            - [ ] Follows C# best practices
            - [ ] Integration with existing code is clean

            Once review is complete and CI passes, this PR will be auto-merged.`
            });
            
            console.log(`Triggered Copilot review for PR #${prNumber}`);
      
      - name: Check for review completion
        if: steps.check_enabled.outputs.enabled == 'true' && steps.check_sessions.outputs.has_updates == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ steps.check_sessions.outputs.pr_number }}');
            
            // Check if PR has copilot-reviewed label
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            const hasReviewedLabel = pr.data.labels.some(label => 
              label.name === 'copilot-reviewed'
            );
            
            if (hasReviewedLabel) {
              console.log('PR has already been reviewed by Copilot');
              
              // Check CI status
              const checks = await github.rest.checks.listForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: pr.data.head.sha
              });
              
              const allPassed = checks.data.check_runs.every(run => 
                run.conclusion === 'success' || run.conclusion === 'skipped'
              );
              
              if (allPassed) {
                console.log('All checks passed, PR ready for auto-merge');
                
                // Add automerge label
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  labels: ['automerge']
                });
              }
            }
