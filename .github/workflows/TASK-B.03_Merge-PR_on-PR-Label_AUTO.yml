name: "TASK-B.03_Merge-PR_on-PR-Label_AUTO.yml"

on:
  workflow_run:
    workflows: ["CI.01_Build-Test_on-Push-PR_AUTO"]
    types:
      - completed

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Check if automation is enabled
        id: check_enabled
        run: |
          # Check if AUTOMATION_ENABLED variable exists and is set to true
          if [ "${{ vars.AUTOMATION_ENABLED }}" != "true" ]; then
            echo "Automation is disabled. Set AUTOMATION_ENABLED repository variable to 'true' to enable."
            echo "enabled=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "enabled=true" >> $GITHUB_OUTPUT
      
      - name: Checkout repository
        if: steps.check_enabled.outputs.enabled == 'true'
        uses: actions/checkout@v4
      
      - name: Get PR information
        if: steps.check_enabled.outputs.enabled == 'true'
        id: get_pr
        uses: actions/github-script@v7
        with:
          script: |
            // Get the pull request associated with this workflow run
            const workflowRun = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });
            
            console.log('Workflow run event:', workflowRun.data.event);
            console.log('Workflow run head branch:', workflowRun.data.head_branch);
            
            // Only process pull_request events
            if (workflowRun.data.event !== 'pull_request') {
              console.log('Not a pull request event, skipping auto-merge');
              return { should_process: false };
            }
            
            // Find the PR for this branch
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${workflowRun.data.head_branch}`
            });
            
            if (prs.data.length === 0) {
              console.log('No open PR found for this branch');
              return { should_process: false };
            }
            
            const pr = prs.data[0];
            console.log(`Found PR #${pr.number}`);
            
            // Check if PR has autogenerated label
            const hasAutoLabel = pr.labels.some(label => label.name === 'autogenerated');
            
            if (!hasAutoLabel) {
              console.log('PR does not have autogenerated label, skipping');
              return { should_process: false };
            }
            
            return {
              should_process: true,
              pr_number: pr.number,
              is_draft: pr.draft
            };
      
      - name: Convert to ready for review
        if: steps.check_enabled.outputs.enabled == 'true' && fromJSON(steps.get_pr.outputs.result).should_process == true && fromJSON(steps.get_pr.outputs.result).is_draft == true
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ fromJSON(steps.get_pr.outputs.result).pr_number }};
            
            // Get PR node_id
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            // Convert from draft to ready for review
            await github.graphql(`
              mutation($pullRequestId: ID!) {
                markPullRequestReadyForReview(input: {pullRequestId: $pullRequestId}) {
                  pullRequest {
                    id
                  }
                }
              }
            `, {
              pullRequestId: pr.data.node_id
            });
            
            console.log(`Converted PR #${prNumber} to ready for review`);
      
      - name: Add automerge label
        if: steps.check_enabled.outputs.enabled == 'true' && fromJSON(steps.get_pr.outputs.result).should_process == true
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ fromJSON(steps.get_pr.outputs.result).pr_number }};
            
            // Add automerge label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ['automerge']
            });
            
            console.log(`Added automerge label to PR #${prNumber}`);
      
      - name: Merge Pull Request
        if: steps.check_enabled.outputs.enabled == 'true' && fromJSON(steps.get_pr.outputs.result).should_process == true
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ fromJSON(steps.get_pr.outputs.result).pr_number }};
            
            try {
              // Merge the PR using squash method
              const result = await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'squash',
                commit_title: `Auto-merge: PR #${prNumber}`,
                commit_message: 'Automatically merged by Flow Auto-Task 02 workflow after successful CI tests.'
              });
              
              console.log(`Successfully merged PR #${prNumber}`);
              console.log(`Merge SHA: ${result.data.sha}`);
            } catch (error) {
              console.error('Failed to merge PR:', error.message);
              
              // If merge fails, comment on the PR
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `⚠️ **Auto-merge failed**\n\nThe automated merge could not be completed. Possible reasons:\n- Merge conflicts\n- Branch protection rules\n- Insufficient permissions\n\nError: ${error.message}\n\nPlease resolve manually.`
              });
              
              throw error;
            }
