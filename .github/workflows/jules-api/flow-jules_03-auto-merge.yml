name: "Flow Jules 03: Auto-Merge After Review"

on:
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to check for auto-merge'
        required: true
        type: number

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Check if Jules automation is enabled
        id: check_enabled
        run: |
          if [ "${{ vars.JULES_AUTOMATION_ENABLED }}" != "true" ]; then
            echo "Jules automation is disabled."
            echo "enabled=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "enabled=true" >> $GITHUB_OUTPUT
      
      - name: Checkout repository
        if: steps.check_enabled.outputs.enabled == 'true'
        uses: actions/checkout@v4
      
      - name: Find PR to merge
        if: steps.check_enabled.outputs.enabled == 'true'
        id: find_pr
        uses: actions/github-script@v7
        with:
          script: |
            let prNumber;
            
            // Check if manual trigger
            if ('${{ inputs.pr_number }}') {
              prNumber = parseInt('${{ inputs.pr_number }}');
            } else if (context.payload.pull_request) {
              prNumber = context.payload.pull_request.number;
            } else if (context.payload.check_suite) {
              // Find PR for this check suite
              const prs = context.payload.check_suite.pull_requests || [];
              if (prs.length > 0) {
                prNumber = prs[0].number;
              }
            }
            
            if (!prNumber) {
              console.log('No PR found to process');
              return { should_process: false };
            }
            
            // Get PR details
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            // Check if PR has jules-pr label
            const hasJulesLabel = pr.data.labels.some(label => 
              label.name === 'jules-pr'
            );
            
            if (!hasJulesLabel) {
              console.log('PR is not a Jules PR, skipping');
              return { should_process: false };
            }
            
            // Check if PR has automerge label
            const hasAutomergeLabel = pr.data.labels.some(label => 
              label.name === 'automerge'
            );
            
            if (!hasAutomergeLabel) {
              console.log('PR does not have automerge label, skipping');
              return { should_process: false };
            }
            
            return {
              should_process: true,
              pr_number: prNumber,
              is_draft: pr.data.draft,
              mergeable: pr.data.mergeable,
              mergeable_state: pr.data.mergeable_state
            };
      
      - name: Verify all checks passed
        if: steps.check_enabled.outputs.enabled == 'true' && fromJSON(steps.find_pr.outputs.result).should_process == true
        id: verify_checks
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ fromJSON(steps.find_pr.outputs.result).pr_number }};
            
            // Get PR
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            // Get all checks for the PR
            const checks = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.data.head.sha
            });
            
            console.log(`Found ${checks.data.check_runs.length} check runs`);
            
            // Check if all required checks passed
            const failedChecks = checks.data.check_runs.filter(run => 
              run.conclusion === 'failure' || run.conclusion === 'cancelled'
            );
            
            const pendingChecks = checks.data.check_runs.filter(run => 
              run.status !== 'completed'
            );
            
            if (failedChecks.length > 0) {
              console.log('Some checks failed:');
              failedChecks.forEach(check => {
                console.log(`  - ${check.name}: ${check.conclusion}`);
              });
              return { all_passed: false, reason: 'failed_checks' };
            }
            
            if (pendingChecks.length > 0) {
              console.log('Some checks are still pending:');
              pendingChecks.forEach(check => {
                console.log(`  - ${check.name}: ${check.status}`);
              });
              return { all_passed: false, reason: 'pending_checks' };
            }
            
            // Also check status checks (for older integrations)
            const statuses = await github.rest.repos.getCombinedStatusForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.data.head.sha
            });
            
            if (statuses.data.state === 'failure') {
              console.log('Status checks failed');
              return { all_passed: false, reason: 'failed_status' };
            }
            
            if (statuses.data.state === 'pending') {
              console.log('Status checks pending');
              return { all_passed: false, reason: 'pending_status' };
            }
            
            console.log('All checks passed!');
            return { all_passed: true };
      
      - name: Convert draft to ready
        if: |
          steps.check_enabled.outputs.enabled == 'true' && 
          fromJSON(steps.find_pr.outputs.result).should_process == true &&
          fromJSON(steps.find_pr.outputs.result).is_draft == true &&
          fromJSON(steps.verify_checks.outputs.result).all_passed == true
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ fromJSON(steps.find_pr.outputs.result).pr_number }};
            
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            await github.graphql(`
              mutation($pullRequestId: ID!) {
                markPullRequestReadyForReview(input: {pullRequestId: $pullRequestId}) {
                  pullRequest {
                    id
                  }
                }
              }
            `, {
              pullRequestId: pr.data.node_id
            });
            
            console.log(`Converted PR #${prNumber} to ready for review`);
      
      - name: Merge pull request
        if: |
          steps.check_enabled.outputs.enabled == 'true' && 
          fromJSON(steps.find_pr.outputs.result).should_process == true &&
          fromJSON(steps.verify_checks.outputs.result).all_passed == true
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ fromJSON(steps.find_pr.outputs.result).pr_number }};
            
            try {
              // Merge the PR
              const result = await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'squash',
                commit_title: `Auto-merge Jules PR #${prNumber}`,
                commit_message: 'Automatically merged after Jules implementation, Copilot review, and successful CI tests.'
              });
              
              console.log(`Successfully merged PR #${prNumber}`);
              console.log(`Merge SHA: ${result.data.sha}`);
              
              // Comment on PR
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `## ✅ Auto-Merged Successfully

            This PR has been automatically merged after:
            - ✅ Jules implementation completed
            - ✅ Copilot Agent review passed
            - ✅ All CI tests passed

            **Merge SHA:** \`${result.data.sha}\`

            The next task will be picked up automatically.`
              });
              
            } catch (error) {
              console.error('Failed to merge PR:', error.message);
              
              // Comment on the PR about the failure
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `## ⚠️ Auto-Merge Failed

            The automated merge could not be completed.

            **Error:** ${error.message}

            **Possible reasons:**
            - Merge conflicts with base branch
            - Branch protection rules not satisfied
            - Insufficient permissions
            - PR is not mergeable

            **Action Required:** Please resolve the issue manually and try merging again.`
              });
              
              throw error;
            }
      
      - name: Close tracking issue
        if: |
          steps.check_enabled.outputs.enabled == 'true' && 
          fromJSON(steps.find_pr.outputs.result).should_process == true &&
          fromJSON(steps.verify_checks.outputs.result).all_passed == true
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ fromJSON(steps.find_pr.outputs.result).pr_number }};
            
            // Find tracking issue linked to this PR
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            // Look for "Closes #X" in PR body
            const issueMatch = pr.data.body?.match(/Closes #(\d+)/);
            
            if (issueMatch) {
              const issueNumber = parseInt(issueMatch[1]);
              
              // Close the issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                state: 'closed'
              });
              
              // Add closing comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `## ✅ Task Completed

            This task has been completed and merged successfully!

            **Pull Request:** #${prNumber}

            The implementation went through:
            1. ✅ Jules AI agent implementation
            2. ✅ Copilot Agent code review
            3. ✅ Automated CI tests
            4. ✅ Auto-merge

            Closing this issue as the task is complete.`
              });
              
              console.log(`Closed tracking issue #${issueNumber}`);
            }
