# .github/workflows/PR.02_Auto-Merge-and-Notify_AUTO.yml
name: "PR.02 | Auto-Merge and Notify | AUTO"

on:
  workflow_run:
    workflows: ["CI.01 | Build & Test | AUTO"]
    types:
      - completed

jobs:
  auto-merge-and-close:
    # Führt den Job nur aus, wenn der CI-Workflow erfolgreich war
    # und der PR von 'jules-bot' erstellt wurde.
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.actor == 'jules-bot'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write # Zum Mergen und Kommentieren
      issues: write        # Zum Schließen von Issues

    steps:
      - name: "Get PR and linked Issue info"
        id: get_info
        uses: actions/github-script@v7
        with:
          script: |
            const pr = github.event.workflow_run.pull_requests[0];
            if (!pr) {
              console.log("Kein Pull Request gefunden.");
              return;
            }

            const { data: pull_request } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });

            // Sucht nach "Closes #<nummer>" oder "Fixes #<nummer>" im PR-Body
            const issue_regex = /(?:closes|fixes)\s+#(\d+)/i;
            const match = pull_request.body.match(issue_regex);
            const issue_number = match ? match[1] : null;

            console.log(`PR Nummer: ${pr.number}`);
            console.log(`Verknüpftes Issue: ${issue_number}`);

            core.setOutput('pr_number', pr.number);
            core.setOutput('issue_number', issue_number);

      - name: "Auto-Merge Pull Request"
        if: steps.get_info.outputs.pr_number
        uses: actions/github-script@v7
        with:
          script: |
            const pr_number = ${{ steps.get_info.outputs.pr_number }};
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr_number,
                merge_method: 'squash' // oder 'merge', 'rebase'
              });
              console.log(`PR #${pr_number} erfolgreich gemerged.`);
            } catch (e) {
              console.error(`Fehler beim Mergen von PR #${pr_number}: ${e.message}`);
              // Optional: Kommentar bei Merge-Konflikt
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr_number,
                body: "Automatischer Merge fehlgeschlagen. Bitte manuell prüfen."
              });
              throw e;
            }

      - name: "Notify and Close Issue"
        if: steps.get_info.outputs.issue_number
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = ${{ steps.get_info.outputs.issue_number }};
            const pr_number = ${{ steps.get_info.outputs.pr_number }};

            // Erfolgsbenachrichtigung im Issue erstellen
            const comment_body = `✅ **Erledigt!**\n\nDieser Task wurde erfolgreich in Pull Request #${pr_number} implementiert und gemerged.`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: comment_body
            });

            // Issue schließen
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              state: 'closed'
            });
            console.log(`Issue #${issue_number} geschlossen.`);
