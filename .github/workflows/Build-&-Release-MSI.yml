name: Build & Release MSI

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release Version (z.B. 1.0.0)'
        required: true
        default: '0.0.3'

permissions:
  contents: write

jobs:
  build-msi:
    runs-on: windows-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Install WiX Toolset
      run: |
        dotnet tool install --global wix
        dotnet tool update --global wix

    - name: Add local tools to PATH
      run: |
        echo "$HOME/.dotnet/tools" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Set Version
      id: set_version
      shell: pwsh
      run: |
        $ver = "${{ github.event.inputs.version }}"
        if ([string]::IsNullOrWhiteSpace($ver)) { $ver = "1.0.0" }
        echo "VERSION=$ver" >> $env:GITHUB_ENV

    - name: Publish Application
      run: |
        dotnet publish src/LightJockey/LightJockey.csproj -c Release -r win-x64 --self-contained false -o ./publish /p:Version=${{ env.VERSION }}
        ls ./publish

    - name: Fail if Publish Output is Empty
      shell: bash
      run: |
        if [ -z "$(ls -A ./publish)" ]; then
          echo "ERROR: Publish output is empty!";
          exit 1;
        fi

    - name: Generate AppComponents.wxs with Heat
      run: |
        wix heat dir ./publish -o installer/AppComponents.wxs -gg -sreg -srd -dr INSTALLFOLDER -cg AppComponents -var var.PublishDir

    - name: Build MSI Installer
      run: dotnet build installer/installer.wixproj -c Release -p:Platform=x64 -p:Version=${{ env.VERSION }}

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: LightJockey-MSI
        path: installer/bin/Release/LightJockey.msi

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ env.VERSION }}
        name: Release v${{ env.VERSION }}
        draft: false
        prerelease: false
        files: installer/bin/Release/LightJockey.msi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
