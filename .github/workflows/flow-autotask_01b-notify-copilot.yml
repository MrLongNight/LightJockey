name: "Flow Auto-Task 01b: Notify for Copilot Action"

on:
  pull_request:
    types: [opened]
    branches:
      - main

jobs:
  notify-copilot-needed:
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.labels.*.name, 'autogenerated')
    permissions:
      pull-requests: write
      issues: write
    
    steps:
      - name: Add comment with instructions
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const issueNumber = context.payload.pull_request.body.match(/Closes #(\d+)/)?.[1];
            
            const comment = `## ü§ñ Auto-Task Ready for Copilot

This PR was automatically created and is ready for implementation.

### Next Steps for Automation:

**Option 1: GitHub Copilot Workspace (Recommended)**
1. Navigate to the linked issue #${issueNumber || 'N/A'}
2. Click on the Copilot icon in the issue
3. Select "Open in Copilot Workspace"
4. Let Copilot implement the task automatically
5. Copilot will commit changes to this PR

**Option 2: Manual Implementation**
1. Check out this branch: \`${context.payload.pull_request.head.ref}\`
2. Implement the task according to the development plan
3. Push changes to this branch
4. CI will automatically test and merge if successful

**Option 3: Copilot Chat in IDE**
1. Open the repository in VS Code
2. Check out branch: \`${context.payload.pull_request.head.ref}\`
3. Ask GitHub Copilot Chat: "Implement ${context.payload.pull_request.title}"
4. Review and commit the suggestions

### Automation Status
- [x] Issue created automatically
- [x] Pull request created automatically  
- [ ] **Awaiting Copilot Workspace activation** ‚ö†Ô∏è
- [ ] Implementation pending
- [ ] CI tests pending
- [ ] Auto-merge pending

---

**Note**: GitHub Copilot Workspace cannot currently be triggered programmatically via GitHub Actions. Manual activation is required.

For more information, see [GitHub Copilot Workspace Documentation](https://githubnext.com/projects/copilot-workspace).`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });
            
            console.log(`Added Copilot workflow instructions to PR #${prNumber}`);
      
      - name: Update PR description
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const currentBody = context.payload.pull_request.body || '';
            
            const updatedBody = `${currentBody}

---

## üö® Action Required

**This PR requires GitHub Copilot Workspace to be manually activated.**

Please follow the instructions in the comments below to complete this task.`;
            
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              body: updatedBody
            });
            
            console.log(`Updated PR #${prNumber} description`);
      
      - name: Assign to repository owner
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            
            // Assign PR to repository owner for visibility
            try {
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                assignees: [context.repo.owner]
              });
              console.log(`Assigned PR #${prNumber} to ${context.repo.owner}`);
            } catch (error) {
              console.log(`Could not assign PR: ${error.message}`);
            }
